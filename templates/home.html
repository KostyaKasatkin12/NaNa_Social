<!DOCTYPE html>
<html lang="en" class="w-full h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome, {{ username }}. Now you are part of - NaNa</title>
    <script>
        tailwind.config = {
            darkMode: 'class',
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen font-poppins w-full h-full text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold leading-relaxed">
                Welcome, {{ username }}. Now you are part of - NaNa
            </h1>
        </header>

        <!-- Stories Section -->
        <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100 flex items-center gap-3">
                <i class="fas fa-camera text-blue-500 dark:text-blue-300"></i> Your Stories
            </h2>
            <div class="mb-6">
                <form id="createStoryForm" method="POST" action="{{ url_for('create_story') }}" enctype="multipart/form-data" class="flex flex-col gap-4">
                    {{ search_form.hidden_tag() }}
                    <textarea name="content" placeholder="Share a story..." class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700 min-h-20 resize-y"></textarea>
                    <label class="text-base font-medium text-gray-700 dark:text-gray-300">
                        Attach Image/Video:
                        <input type="file" name="image" accept="image/*,video/*" class="block w-full mt-2 text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-500 dark:file:text-blue-400 hover:file:bg-blue-100 dark:hover:file:bg-blue-800"/>
                    </label>
                    <button type="submit" class="px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-700 transform hover:scale-105 transition duration-300">Add Story</button>
                </form>
            </div>
            <div class="stories-container flex overflow-x-auto gap-4">
                {% for story in stories %}
                    <div class="story bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md min-w-[150px] flex flex-col items-center">
                        {% if story.image %}
                            {% set ext = story.image|split('.')|last|lower %}
                            {% if ext in ['mp4', 'mov', 'avi'] %}
                                <video src="{{ url_for('serve_story_file', filename=story.image) }}" class="w-20 h-20 rounded-full object-cover mb-2" controls></video>
                            {% else %}
                                <img src="{{ url_for('serve_story_file', filename=story.image) }}" alt="Story" class="w-20 h-20 rounded-full object-cover mb-2">
                            {% endif %}
                        {% else %}
                            <div class="w-20 h-20 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mb-2">
                                <span class="text-gray-500 dark:text-gray-400">No Media</span>
                            </div>
                        {% endif %}
                        <p class="text-sm text-gray-700 dark:text-gray-300 text-center">{{ story[2]|truncate(20) }}</p>
                        <button onclick="viewStory({{ story[0] }})" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">View</button>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Modal for Story Viewing -->
        <div id="storyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Story</h2>
                <div class="mb-6">
                    <div id="storyMedia" class="w-full h-96 mb-4 flex items-center justify-center">
                        <!-- Media will be inserted here -->
                    </div>
                    <p id="storyCaption" class="text-gray-700 dark:text-gray-300 text-center"></p>
                </div>
                <button onclick="closeModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transform hover:scale-105 transition duration-300 w-full">Close</button>
            </div>
        </div>

        <main class="flex flex-col md:flex-row gap-8 min-h-[calc(100vh-300px)]">
            <!-- Left Sidebar (Friends and Friend Requests) -->
            <div class="w-full md:w-2/5 flex flex-col gap-0 md:gap-6 md:flex-1 md:sticky md:top-6 h-[50vh]">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition h-full overflow-y-hidden">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-users text-blue-500 dark:text-blue-400"></i> Your Friends
                    </h2>
                    {% if friends %}
                        <ul class="space-y-3 friend-list">
                            {% for friend in friends %}
                                <li class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-blue-500 dark:text-blue-400"></i>
                                    </div>
                                    <a href="{{ url_for('create_chat', friend_id=friend[1]) }}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">{{ friend[0] }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-gray-500 dark:text-gray-400 italic">No friends yet.</p>
                    {% endif %}
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg transition h-full overflow-y-hidden">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-user-plus text-blue-500 dark:text-blue-400"></i> Friend Requests
                    </h2>
                    <ul class="space-y-3 friend-requests">
                        {% for request in friend_requests %}
                            <li class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700" data-sender-id="{{ request[0] }}">
                                <span class="font-medium text-gray-700 dark:text-gray-300">{{ request[1] }}</span>
                                <div class="flex gap-2">
                                    <form action="{{ url_for('accept_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                        {{ search_form.hidden_tag() }}
                                        <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Accept</button>
                                    </form>
                                    <form action="{{ url_for('reject_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                        {{ search_form.hidden_tag() }}
                                        <button type="submit" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 hover:scale-105 transition min-h-12">Reject</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="w-full md:w-3/5 flex flex-col gap-6">
                <div class="bg-gradient-to-br from-white to-gray-100 dark:from-gray-800 dark:to-gray-900 p-6 sm:p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
                            <i class="fas fa-pen text-blue-500 dark:text-blue-300"></i> Create a Post
                        </h2>
                        <div class="flex gap-4">
                            <a href="{{ url_for('face_detector') }}" class="px-5 py-3 bg-green-500 dark:bg-green-600 text-white rounded-xl hover:bg-green-600 dark:hover:bg-green-700 transform hover:scale-105 transition duration-300">Capture Photo</a>
                            <a href="{{ url_for('profile') }}" class="px-5 py-3 bg-blue-500 dark:bg-blue-600 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-700 transform hover:scale-105 transition duration-300">Edit Profile</a>
                        </div>
                    </div>
                    <form id="postForm" method="POST" action="{{ url_for('create_post') }}" enctype="multipart/form-data" class="flex flex-col gap-6">
                        {{ search_form.hidden_tag() }}
                        <textarea name="content" id="postContent" placeholder="What's on your mind?" required class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700 min-h-32 resize-y"></textarea>
                        <div id="photoPreview" class="mt-4"></div>
                        <input type="hidden" name="photo_path" id="photoPath">
                        <input type="hidden" name="emotion" id="emotionInput">
                        <label class="text-base font-medium text-gray-700 dark:text-gray-300">
                            Attach Image:
                            <input type="file" name="image" accept="image/*" class="block w-full mt-2 text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-500 dark:file:text-blue-400 hover:file:bg-blue-100 dark:hover:file:bg-blue-800"/>
                        </label>
                        <div class="flex gap-4">
                            <button type="submit" class="px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-700 transform hover:scale-105 transition duration-300">Post</button>
                            <button type="button" id="aiEnhanceBtn" class="px-6 py-3 bg-purple-500 dark:bg-purple-600 text-white rounded-xl hover:bg-purple-600 dark:hover:bg-purple-700 transform hover:scale-105 transition duration-300">AI Enhance</button>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 italic">Powered by NaNa_AI</div>
                    </form>
                </div>

                <!-- Modal for Post Selection -->
                <div id="postModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-2xl">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Choose Your Post</h2>
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Original Post</h3>
                            <p id="originalPost" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-xl text-gray-700 dark:text-gray-300"></p>
                            <button onclick="submitPost('original')" class="mt-4 px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-700 transform hover:scale-105 transition duration-300 w-full">Post Original</button>
                        </div>
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">NaNa_AI Enhanced Post</h3>
                            <p id="enhancedPost" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-xl text-gray-700 dark:text-gray-300"></p>
                            <button onclick="submitPost('enhanced')" class="mt-4 px-6 py-3 bg-purple-500 dark:bg-purple-600 text-white rounded-xl hover:bg-purple-600 dark:hover:bg-purple-700 transform hover:scale-105 transition duration-300 w-full">Post Enhanced</button>
                        </div>
                        <button onclick="closeModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transform hover:scale-105 transition duration-300 w-full">Cancel</button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-white to-gray-100 dark:from-gray-800 dark:to-gray-900 p-6 sm:p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100 flex items-center gap-3">
                        <i class="fas fa-newspaper text-blue-500 dark:text-blue-300"></i> Posts
                    </h2>
                    <div id="posts" class="space-y-6">
                        {% for post in posts[:5] %}
                            <div class="post p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-lg transition duration-300" data-post-id="{{ post[0] }}">
                                <p class="text-lg font-semibold"><strong>{{ post[3] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[2] }})</span>
                                    {% if post[9] %}
                                        <span class="text-blue-500 dark:text-blue-400"> | Эмоция: {{ post[9] }}</span>
                                    {% endif %}
                                </p>
                                <p class="text-gray-700 dark:text-gray-300 mt-2 leading-relaxed">{{ post[1] }}</p>
                                {% if post[4] %}
                                    <img src="{{ url_for('static', filename='avatars/' + post[4]) }}" alt="Post image" class="mt-4 max-w-full rounded-lg shadow-md"/>
                                {% endif %}
                                <div class="flex gap-6 mt-4 items-center">
                                    <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">
                                        {% if post[7] == 'like' %}Unlike{% else %}Like{% endif %}
                                    </button>
                                    <span class="like-count text-gray-500 dark:text-gray-400">{{ post[5] }} likes</span>
                                    <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">
                                        {% if post[7] == 'dislike' %}Undislike{% else %}Dislike{% endif %}
                                    </button>
                                    <span class="dislike-count text-gray-500 dark:text-gray-400">{{ post[6] }} dislikes</span>
                                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">Comment</button>
                                </div>
                                <!-- Latest Comment -->
                                {% if post[8] %}
                                    <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg" id="latest-comment-{{ post[0] }}">
                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>{{ post[8][2] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[8][1] }})</span></p>
                                        <p class="text-gray-700 dark:text-gray-300">{{ post[8][0] }}</p>
                                    </div>
                                {% else %}
                                    <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-{{ post[0] }}"></div>
                                {% endif %}
                                <div class="comments-section mt-4 hidden" id="comments-{{ post[0] }}">
                                    <div class="comments-list space-y-3"></div>
                                    <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="{{ post[0] }}">
                                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                                        <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% if posts|length > 5 %}
                        <button id="loadMorePosts" class="mt-4 px-6 py-3 bg-blue-500 dark:bg-blue-600 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-700 transform hover:scale-105 transition duration-300 w-full">Next</button>
                    {% endif %}
                </div>

                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-md hover:shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-search text-blue-400"></i> Search Friends
                    </h2>
                    <form method="POST" action="{{ url_for('search_user') }}" class="flex gap-3">
                        {{ search_form.hidden_tag() }}
                        <input type="text" name="username" placeholder="Search for users..." required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500"/>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition min-h-[2.5rem]">Search</button>
                    </form>
                </div>
            </div>

            <!-- Right Sidebar (Chats and Notifications) -->
            <div class="w-full md:w-2/5 flex flex-col gap-0 md:gap-6 md:flex-none md:sticky md:top-6 h-[50vh]">
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-xl h-full overflow-y-hidden">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2">
                        <i class="fas fa-comment-alt text-blue-400"></i> Chats
                    </h2>
                    <ul id="chats-list" class="space-y-3">
                        {% for chat in chats %}
                            <li class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition" data-chat-id="{{ chat[0] }}">
                                <a href="{{ url_for('chat', chat_id=chat[0]) }}" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">{{ chat[1] }}</a>
                                {% if chat[2] > 0 %}
                                    <span class="bg-blue-600 text-white text-xs font-semibold rounded-full px-2 py-1">{{ chat[2] }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-xl h-full overflow-y-hidden">
                    <form id="notifications-form" style="display: none;">
                        {{ search_form.hidden_tag() }}
                    </form>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                            <i class="fas fa-bell text-blue-400"></i> Notifications
                        </h2>
                        <button id="clear-notifications" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition min-h-[2.5rem]">Clear All</button>
                    </div>
                    <ul id="notifications-list" class="space-y-3">
                        {% if notifications %}
                            {% for notification in notifications %}
                                <li class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    {{ notification[0] }}
                                    {% if notification[1] %}
                                        <span class="text-gray-500 dark:text-gray-400">({{ notification[1] }})</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 dark:text-gray-400">
            <div>
                <a href="{{ url_for('logout') }}" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">Logout</a> | © 2025 Nana Social Network
            </div>
            <div class="mt-2">CEO: Kasatkin K.</div>
        </footer>
    </div>

    <script>
        const socket = io.connect(window.location.origin);
        const userId = {{ session['user_id'] | tojson }};

        socket.on('connect', () => {
            console.log('Connected to SocketIO server');
            socket.emit('join_room', userId);
            console.log(`Joined user room: ${userId}`);
        });

        socket.on('connect_error', (error) => {
            console.error('SocketIO connection error:', error);
        });

        socket.on('update_notifications', function(data) {
            if (data.user_id !== userId) return;
            console.log('Received update_notifications:', data);
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                    const content = notification[0];
                    const created_at = notification[1] ? ` <span class="text-gray-500 dark:text-gray-400">(${notification[1]})</span>` : '';
                    li.innerHTML = content + created_at;
                    notificationsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'p-3 text-gray-500 dark:text-gray-400 italic';
                li.textContent = 'No new notifications';
                notificationsList.appendChild(li);
            }
        });

        socket.on('new_message', function(data) {
            if (data.sender_id !== userId) {
                console.log('New message received:', data);
                const chatsList = document.getElementById('chats-list');
                const chatItem = chatsList.querySelector(`[data-chat-id="${data.chat_id}"]`);
                if (chatItem) {
                    const unreadSpan = chatItem.querySelector('span');
                    let unreadCount = unreadSpan ? parseInt(unreadSpan.textContent) + 1 : 1;
                    if (unreadSpan) {
                        unreadSpan.textContent = unreadCount;
                    } else {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'bg-blue-500 dark:bg-blue-600 text-white text-xs px-2 py-1 rounded-full';
                        newSpan.textContent = unreadCount;
                        chatItem.appendChild(newSpan);
                    }
                }
            }
        });

        document.getElementById('clear-notifications').addEventListener('click', () => {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch('/clear_notifications', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Notifications cleared');
                    const notificationsList = document.getElementById('notifications-list');
                    notificationsList.innerHTML = '<li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>';
                } else {
                    console.error('Failed to clear notifications:', data.message);
                    alert('Failed to clear notifications: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error clearing notifications:', error);
                alert('Error clearing notifications. Please try again.');
            });
        });

        socket.on('new_friend_request', function(data) {
            if (data.sender_id !== userId) {
                const friendRequests = document.querySelector('.friend-requests');
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700';
                li.dataset.senderId = data.sender_id;
                li.innerHTML = `
                    <span class="font-medium text-gray-700 dark:text-gray-300">${data.sender_username}</span>
                    <div class="flex gap-2">
                        <form action="/accept_friend/${data.sender_id}" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="${document.querySelector('#notifications-form input[name="csrf_token"]').value}">
                            <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Accept</button>
                        </form>
                        <form action="/reject_friend/${data.sender_id}" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="${document.querySelector('#notifications-form input[name="csrf_token"]').value}">
                            <button type="submit" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 hover:scale-105 transition min-h-12">Reject</button>
                        </form>
                    </div>
                `;
                friendRequests.appendChild(li);
            }
        });

        socket.on('friend_request_accepted', function(data) {
            if (data.friend_id !== userId) {
                const friendList = document.querySelector('.friend-list');
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                li.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-500 dark:text-blue-400"></i>
                    </div>
                    <a href="/create_chat/${data.friend_id}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">${data.friend_username}</a>
                `;
                friendList.appendChild(li);
                const requestLi = document.querySelector(`.friend-requests li[data-sender-id="${data.friend_id}"]`);
                if (requestLi) requestLi.remove();
            }
        });

        socket.on('friend_request_rejected', function(data) {
            if (data.friend_id !== userId) {
                const requestLi = document.querySelector(`.friend-requests li[data-sender-id="${data.friend_id}"]`);
                if (requestLi) requestLi.remove();
            }
        });

        socket.on('new_post', function(data) {
            const postsContainer = document.getElementById('posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-lg transition duration-300';
            postDiv.dataset.postId = data.id;
            const emotion = data.emotion ? ` <span class="text-blue-500 dark:text-blue-400"> | Эмоция: ${data.emotion}</span>` : '';
            postDiv.innerHTML = `
                <p class="text-lg font-semibold"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span>${emotion}</p>
                <p class="text-gray-700 dark:text-gray-300 mt-2 leading-relaxed">${data.content}</p>
                ${data.image ? `<img src="${url_for('static', filename='avatars/' + data.image)}" alt="Post image" class="mt-4 max-w-full rounded-lg shadow-md"/>` : ''}
                <div class="flex gap-6 mt-4 items-center">
                    <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Like</button>
                    <span class="like-count text-gray-500 dark:text-gray-400">${data.likes} likes</span>
                    <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Dislike</button>
                    <span class="dislike-count text-gray-500 dark:text-gray-400">${data.dislikes} dislikes</span>
                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Comment</button>
                </div>
                <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-${data.id}"></div>
                <div class="comments-section mt-4 hidden" id="comments-${data.id}">
                    <div class="comments-list space-y-3"></div>
                    <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="${data.id}">
                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                        <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                    </form>
                </div>
            `;
            postsContainer.prepend(postDiv);
            attachCommentListeners();
            attachReactionListeners();
        });

        socket.on('post_reaction_updated', function(data) {
            const post = document.querySelector(`.post[data-post-id="${data.post_id}"]`);
            if (post) {
                const likeButton = post.querySelector('.like-btn');
                const dislikeButton = post.querySelector('.dislike-btn');
                const likeSpan = post.querySelector('.like-count');
                const dislikeSpan = post.querySelector('.dislike-count');
                likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                likeSpan.textContent = `${data.likes} likes`;
                dislikeSpan.textContent = `${data.dislikes} dislikes`;
            }
        });

        socket.on('new_story', function(data) {
            if (data.user_id !== userId) {
                const storiesContainer = document.querySelector('.stories-container');
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md min-w-[150px] flex flex-col items-center';
                const ext = data.image ? data.image.split('.').pop().toLowerCase() : '';
                storyDiv.innerHTML = `
                    ${data.image ? (ext in ['mp4', 'mov', 'avi'] ?
                        `<video src="{{ url_for('serve_story_file', filename='') }}${data.image}" class="w-20 h-20 rounded-full object-cover mb-2" controls></video>` :
                        `<img src="{{ url_for('serve_story_file', filename='') }}${data.image}" alt="Story" class="w-20 h-20 rounded-full object-cover mb-2">`) :
                        `<div class="w-20 h-20 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mb-2">
                            <span class="text-gray-500 dark:text-gray-400">No Media</span>
                        </div>`}
                    <p class="text-sm text-gray-700 dark:text-gray-300 text-center">${data.content || 'No content'}</p>
                    <button onclick="viewStory(${data.story_id})" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">View</button>
                `;
                storiesContainer.appendChild(storyDiv);
            }
        });

        function attachReactionListeners() {
            document.querySelectorAll('.like-btn').forEach(button => {
                button.removeEventListener('click', handleLikeClick);
                button.addEventListener('click', handleLikeClick);
            });

            document.querySelectorAll('.dislike-btn').forEach(button => {
                button.removeEventListener('click', handleDislikeClick);
                button.addEventListener('click', handleDislikeClick);
            });
        }

        function handleLikeClick() {
            const postId = this.dataset.postId;
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/like_post/${postId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const post = document.querySelector(`.post[data-post-id="${postId}"]`);
                    const likeButton = post.querySelector('.like-btn');
                    const dislikeButton = post.querySelector('.dislike-btn');
                    const likeSpan = post.querySelector('.like-count');
                    const dislikeSpan = post.querySelector('.dislike-count');
                    likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                    dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                    likeSpan.textContent = `${data.likes} likes`;
                    dislikeSpan.textContent = `${data.dislikes} dislikes`;
                } else {
                    alert('Error liking post: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error liking post:', error);
                alert('Error liking post. Please try again.');
            });
        }

        function handleDislikeClick() {
            const postId = this.dataset.postId;
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/dislike_post/${postId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const post = document.querySelector(`.post[data-post-id="${postId}"]`);
                    const likeButton = post.querySelector('.like-btn');
                    const dislikeButton = post.querySelector('.dislike-btn');
                    const likeSpan = post.querySelector('.like-count');
                    const dislikeSpan = post.querySelector('.dislike-count');
                    likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                    dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                    likeSpan.textContent = `${data.likes} likes`;
                    dislikeSpan.textContent = `${data.dislikes} dislikes`;
                } else {
                    alert('Error disliking post: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error disliking post:', error);
                alert('Error disliking post. Please try again.');
            });
        }

        function submitPost(type) {
            const postContent = document.getElementById('postContent');
            if (type === 'original') {
                postContent.value = document.getElementById('originalPost').textContent;
            } else {
                postContent.value = document.getElementById('enhancedPost').textContent;
            }
            document.getElementById('postForm').submit();
        }

        function closeModal() {
            document.getElementById('postModal').classList.add('hidden');
            document.getElementById('storyModal').classList.add('hidden');
        }

        document.getElementById('aiEnhanceBtn').addEventListener('click', () => {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                alert('Please enter some text to enhance.');
                return;
            }
            fetch('/enhance_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('#notifications-form input[name="csrf_token"]').value
                },
                body: JSON.stringify({ content })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const originalPost = document.getElementById('originalPost');
                    const enhancedPost = document.getElementById('enhancedPost');
                    originalPost.textContent = data.original_content || 'No original content';
                    enhancedPost.textContent = data.enhanced_content || data.original_content + '.';
                    document.getElementById('postModal').classList.remove('hidden');
                } else {
                    alert('Error enhancing post: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error enhancing post:', error);
                alert('Error enhancing post. Please try again or check the console for details.');
            });
        });

        let currentOffset = 5;

        document.getElementById('loadMorePosts')?.addEventListener('click', () => {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/get_more_posts?offset=${currentOffset}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.posts.length > 0) {
                    const postsContainer = document.getElementById('posts');
                    data.posts.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md hover:shadow-lg transition duration-300';
                        postDiv.dataset.postId = post.id;
                        const emotion = post.emotion ? ` <span class="text-blue-500 dark:text-blue-400"> | Эмоция: ${post.emotion}</span>` : '';
                        postDiv.innerHTML = `
                            <p class="text-lg font-semibold"><strong>${post.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${post.created_at})</span>${emotion}</p>
                            <p class="text-gray-700 dark:text-gray-300 mt-2 leading-relaxed">${post.content}</p>
                            ${post.image ? `<img src="${url_for('static', filename='avatars/' + post.image)}" alt="Post image" class="mt-4 max-w-full rounded-lg shadow-md"/>` : ''}
                            <div class="flex gap-6 mt-4 items-center">
                                <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Like</button>
                                <span class="like-count text-gray-500 dark:text-gray-400">${post.likes} likes</span>
                                <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Dislike</button>
                                <span class="dislike-count text-gray-500 dark:text-gray-400">${post.dislikes} dislikes</span>
                                <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Comment</button>
                            </div>
                            <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-${post.id}"></div>
                            <div class="comments-section mt-4 hidden" id="comments-${post.id}">
                                <div class="comments-list space-y-3"></div>
                                <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="${post.id}">
                                    <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                                </form>
                            </div>
                        `;
                        postsContainer.appendChild(postDiv);
                    });
                    currentOffset += 5;
                    if (data.posts.length < 5) {
                        document.getElementById('loadMorePosts').remove();
                    }
                    attachCommentListeners();
                    attachReactionListeners();
                } else {
                    document.getElementById('loadMorePosts').remove();
                }
            })
            .catch(error => {
                console.error('Error loading more posts:', error);
                alert('Error loading more posts. Please try again.');
            });
        });

        function fetchComments(postId) {
            fetch(`/get_comments/${postId}`)
                .then(response => response.json())
                .then(data => {
                    const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
                    commentsList.innerHTML = '';
                    if (data.status === 'success' && data.comments.length > 0) {
                        data.comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${comment.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${comment.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${comment.content}</p>
                            `;
                            commentsList.appendChild(commentDiv);
                        });
                    } else {
                        commentsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No comments yet.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                });
        }

        function attachCommentListeners() {
            document.querySelectorAll('.comment-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const postId = button.dataset.postId;
                    const commentsSection = document.getElementById(`comments-${postId}`);
                    commentsSection.classList.toggle('hidden');
                    if (!commentsSection.classList.contains('hidden')) {
                        fetchComments(postId);
                    }
                });
            });

            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const postId = form.dataset.postId;
                    const content = form.querySelector('textarea').value;
                    fetch('/add_comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('#notifications-form input[name="csrf_token"]').value
                        },
                        body: JSON.stringify({ post_id: postId, content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>
                            `;
                            commentsList.appendChild(commentDiv);
                            const latestComment = document.getElementById(`latest-comment-${postId}`);
                            latestComment.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>
                            `;
                            latestComment.classList.remove('hidden');
                            form.querySelector('textarea').value = '';
                        } else {
                            alert('Error adding comment: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error adding comment:', error);
                        alert('Error adding comment. Please try again.');
                    });
                });
            });
        }

        function viewStory(storyId) {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/view_story/${storyId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetch(`/get_story/${storyId}`)
                        .then(response => response.json())
                        .then(story => {
                            if (story.status === 'success') {
                                const mediaDiv = document.getElementById('storyMedia');
                                const captionDiv = document.getElementById('storyCaption');
                                if (story.image) {
                                    const ext = story.image.split('.').pop().toLowerCase();
                                    if (['mp4', 'mov', 'avi'].includes(ext)) {
                                        mediaDiv.innerHTML = `<video controls class="max-w-full max-h-96 object-contain"><source src="{{ url_for('serve_story_file', filename='') }}${story.image}" type="video/${ext}">Your browser does not support the video tag.</video>`;
                                    } else {
                                        mediaDiv.innerHTML = `<img src="{{ url_for('serve_story_file', filename='') }}${story.image}" alt="Story" class="max-w-full max-h-96 object-contain">`;
                                    }
                                } else {
                                    mediaDiv.innerHTML = `<div class="w-full h-96 bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><span class="text-gray-500 dark:text-gray-400">No Media</span></div>`;
                                }
                                captionDiv.textContent = story.content || 'No caption';
                                document.getElementById('storyModal').classList.remove('hidden');
                            } else {
                                alert('Error loading story: ' + story.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching story:', error);
                            alert('Error loading story. Please try again.');
                        });
                } else {
                    alert('Error viewing story: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error viewing story:', error);
                alert('Error viewing story. Please try again.');
            });
        }

        function get_story(storyId) {
            // This is a placeholder; implement the actual route in main.py
            fetch(`/get_story/${storyId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        return data;
                    } else {
                        throw new Error(data.message);
                    }
                });
        }

        attachCommentListeners();
        attachReactionListeners();

        const urlParams = new URLSearchParams(window.location.search);
        const photoPath = urlParams.get('photo_path');
        const emotion = urlParams.get('emotion');
        const content = urlParams.get('content');
        if (photoPath) {
            document.getElementById('photoPath').value = photoPath; // Use full path
            const filename = photoPath.split('/').pop(); // Extract filename for preview
            document.getElementById('photoPreview').innerHTML = `<img src="${url_for('static', filename='avatars/' + filename)}" alt="Captured photo" class="mt-4 max-w-full rounded-lg"/>`;
            if (emotion) {
                document.getElementById('emotionInput').value = emotion;
            }
            if (content) {
                document.getElementById('postContent').value = content;
            }
        }
    </script>
</body>
</html>
