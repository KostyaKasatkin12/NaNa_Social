<!DOCTYPE html>
<html lang="en" class="w-full h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome, {{ username }}. Now you are part of - NaNa</title>
    <script>
        tailwind.config = {
            darkMode: 'class',
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #8b5cf6;
            --accent: #10b981;
        }

        .story-gradient {
            background: linear-gradient(45deg, #8b5cf6, #3b82f6, #06b6d4);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            color: white;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .input-modern {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: white;
            color: #1f2937; /* Черный текст */
        }

        .dark .input-modern {
            border-color: #4b5563;
            background: #374151;
            color: #f9fafb; /* Белый текст в темной теме */
        }

        .input-modern:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .post-card {
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .post-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .dark .post-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .notification-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stories-container::-webkit-scrollbar {
            height: 6px;
        }

        .stories-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .stories-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        .dark .stories-container::-webkit-scrollbar-track {
            background: #374151;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }

        .story-circle {
            position: relative;
            background: linear-gradient(45deg, #f59e0b, #ec4899, #8b5cf6);
            padding: 3px;
            border-radius: 50%;
        }

        .story-inner {
            background: white;
            border-radius: 50%;
            padding: 2px;
        }

        .dark .story-inner {
            background: #1f2937;
        }

        /* Фикс для текста в формах */
        textarea, input[type="text"] {
            color: #1f2937 !important;
        }

        .dark textarea, .dark input[type="text"] {
            color: #f9fafb !important;
        }

        /* Улучшенный вид для кнопок историй */
        .story-view-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 500;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
            margin-top: 8px;
            font-size: 0.875rem;
        }

        .story-view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 min-h-screen font-poppins text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-8 rounded-2xl shadow-xl mb-8 text-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-500/20"></div>
            <div class="relative z-10">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight mb-4">
                    Welcome, <span class="text-yellow-300">{{ username }}</span>
                </h1>
                <p class="text-xl opacity-90">Now you are part of <span class="font-bold text-blue-200">NaNa</span></p>
                <div class="mt-4 flex items-center justify-center gap-3">
                    <i class="fas fa-heart text-red-400"></i>
                    <span class="text-blue-100">Connect, Share, Discover</span>
                    <i class="fas fa-heart text-red-400"></i>
                </div>
            </div>
        </header>

        <!-- Stories Section -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg mb-8 post-card">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white">
                        <i class="fas fa-camera"></i>
                    </div>
                    Your Stories
                </h2>
                <span class="text-sm font-medium px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                    {{ stories|length }} stories
                </span>
            </div>

            <div class="mb-6">
                <form id="createStoryForm" method="POST" action="{{ url_for('create_story') }}" enctype="multipart/form-data" class="space-y-4">
                    {{ search_form.hidden_tag() }}
                    <div>
                        <textarea name="content" placeholder="What's happening? Share your story..."
                                class="input-modern w-full p-4 min-h-[100px] resize-none"></textarea>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 flex items-center justify-center">
                                <i class="fas fa-image text-blue-600 dark:text-blue-400 text-lg"></i>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700 dark:text-gray-300 block">Add Media</span>
                                <input type="file" name="image" accept="image/*,video/*"
                                       class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300 hover:file:bg-blue-200 dark:hover:file:bg-blue-800">
                            </div>
                        </label>

                        <button type="submit" class="btn-primary px-6 py-3 rounded-xl font-semibold flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Story
                        </button>
                    </div>
                </form>
            </div>

            <div class="stories-container flex overflow-x-auto gap-6 pb-4 px-2">
                {% for story in stories %}
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="story-circle mb-3">
                            <div class="story-inner">
                                {% if story.image %}
                                    {% set ext = story.image|split('.')|last|lower %}
                                    {% if ext in ['mp4', 'mov', 'avi'] %}
                                        <video src="{{ url_for('serve_story_file', filename=story.image) }}"
                                               class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-800"></video>
                                    {% else %}
                                        <img src="{{ url_for('serve_story_file', filename=story.image) }}"
                                             alt="Story" class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-800">
                                    {% endif %}
                                {% else %}
                                    <div class="w-20 h-20 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 border-4 border-white dark:border-gray-800 flex items-center justify-center">
                                        <i class="fas fa-feather text-gray-400 dark:text-gray-500 text-xl"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-sm text-center font-medium text-gray-700 dark:text-gray-300 truncate max-w-[100px] mb-2">
                            {{ story[2]|truncate(15) }}
                        </p>
                        <button onclick="viewStory({{ story[0] }})" class="story-view-btn">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                    </div>
                {% endfor %}
                {% if not stories %}
                    <div class="flex items-center justify-center w-full py-10 text-gray-400 dark:text-gray-500">
                        <div class="text-center">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 mx-auto mb-4 flex items-center justify-center">
                                <i class="fas fa-images text-2xl"></i>
                            </div>
                            <p class="font-medium">No stories yet</p>
                            <p class="text-sm mt-1">Share your first story!</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Sidebar - Friends & Friend Requests -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Friends Card -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg post-card">
                    <div class="flex items-center justify-between mb-5">
                        <h3 class="text-xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 flex items-center justify-center text-white">
                                <i class="fas fa-users"></i>
                            </div>
                            Friends
                        </h3>
                        <span class="text-sm font-medium px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                            {{ friends|length }}
                        </span>
                    </div>

                    <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        {% if friends %}
                            {% for friend in friends %}
                                <a href="{{ url_for('create_chat', friend_id=friend[1]) }}"
                                   class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition group">
                                    <div class="relative">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-semibold text-lg">
                                            {{ friend[0][0]|upper }}
                                        </div>
                                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></div>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition">
                                            {{ friend[0] }}
                                        </h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Click to chat</p>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-500 transition"></i>
                                </a>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 mx-auto mb-3 flex items-center justify-center">
                                    <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 dark:text-gray-400">No friends yet</p>
                                <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Search for friends below!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Friend Requests Card -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg post-card">
                    <div class="flex items-center justify-between mb-5">
                        <h3 class="text-xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center text-white">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                {% if friend_requests %}
                                    <span class="notification-dot absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center text-xs text-white">
                                        {{ friend_requests|length }}
                                    </span>
                                {% endif %}
                            </div>
                            Friend Requests
                        </h3>
                    </div>

                    <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        {% for request in friend_requests %}
                            <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-orange-400 to-pink-400 flex items-center justify-center text-white font-semibold">
                                        {{ request[1][0]|upper }}
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200">{{ request[1] }}</h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Wants to connect</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <form action="{{ url_for('accept_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                        {{ search_form.hidden_tag() }}
                                        <button type="submit"
                                                class="w-9 h-9 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-white flex items-center justify-center hover:scale-110 transition">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                    <form action="{{ url_for('reject_friend', friend_id=request[0]) }}" method="POST" class="inline">
                                        {{ search_form.hidden_tag() }}
                                        <button type="submit"
                                                class="w-9 h-9 rounded-full bg-gradient-to-r from-gray-300 to-gray-400 dark:from-gray-600 dark:to-gray-700 text-gray-700 dark:text-gray-300 flex items-center justify-center hover:scale-110 transition">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                        {% if not friend_requests %}
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 mx-auto mb-3 flex items-center justify-center">
                                    <i class="fas fa-inbox text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 dark:text-gray-400">No pending requests</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Main Content - Posts -->
            <div class="lg:col-span-6 space-y-6">
                <!-- Create Post Card -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl post-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white">
                                <i class="fas fa-pen"></i>
                            </div>
                            Create Post
                        </h3>
                        <div class="flex gap-3">
                            <a href="{{ url_for('face_detector') }}"
                               class="btn-secondary px-5 py-2.5 rounded-xl flex items-center gap-2 font-semibold">
                                <i class="fas fa-camera"></i>
                                Photo
                            </a>
                            <a href="{{ url_for('profile') }}"
                               class="bg-gradient-to-r from-gray-700 to-gray-800 dark:from-gray-600 dark:to-gray-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 font-semibold hover:shadow-lg transition">
                                <i class="fas fa-user-edit"></i>
                                Profile
                            </a>
                        </div>
                    </div>

                    <form id="postForm" method="POST" action="{{ url_for('create_post') }}" enctype="multipart/form-data" class="space-y-5">
                        {{ search_form.hidden_tag() }}

                        <div>
                            <textarea name="content" id="postContent"
                                     placeholder="What's on your mind, {{ username }}?" required
                                     class="input-modern w-full p-4 min-h-[120px] resize-none"></textarea>
                        </div>

                        <div id="photoPreview" class="mt-4"></div>
                        <input type="hidden" name="photo_path" id="photoPath">
                        <input type="hidden" name="emotion" id="emotionInput">

                        <div class="flex items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-5">
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 flex items-center justify-center">
                                        <i class="fas fa-image text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <span class="font-medium text-gray-700 dark:text-gray-300 hidden sm:block">Photo/Video</span>
                                    <input type="file" name="image" accept="image/*"
                                           class="hidden" id="postImageInput">
                                </label>

                                <button type="button" id="aiEnhanceBtn"
                                        class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 text-purple-700 dark:text-purple-400 font-medium hover:shadow transition">
                                    <i class="fas fa-magic"></i>
                                    <span>AI Enhance</span>
                                </button>
                            </div>

                            <div class="flex items-center gap-3">
                                <span class="text-sm text-gray-500 dark:text-gray-400 hidden sm:block">
                                    <i class="fas fa-robot text-purple-500 mr-1"></i> NaNa_AI
                                </span>
                                <button type="submit"
                                        class="btn-primary px-6 py-3 rounded-xl flex items-center gap-2 font-semibold">
                                    <i class="fas fa-paper-plane"></i>
                                    Post
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Posts Section -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl post-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-orange-500 to-yellow-500 flex items-center justify-center text-white">
                                <i class="fas fa-newspaper"></i>
                            </div>
                            Recent Posts
                        </h3>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-fire text-orange-500"></i>
                            <span class="text-sm font-semibold text-gray-600 dark:text-gray-300">Latest Updates</span>
                        </div>
                    </div>

                    <div id="posts" class="space-y-6">
                        {% for post in posts[:5] %}
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 post-card" data-post-id="{{ post[0] }}">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-semibold text-lg">
                                            {{ post[3][0]|upper }}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-800 dark:text-gray-200">{{ post[3] }}</h4>
                                            <div class="flex items-center gap-2 text-sm">
                                                <span class="text-gray-500 dark:text-gray-400">{{ post[2] }}</span>
                                                {% if post[9] %}
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-pink-100 to-rose-100 dark:from-pink-900/30 dark:to-rose-900/30 text-pink-600 dark:text-pink-400">
                                                        {{ post[9] }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <p class="text-gray-800 dark:text-gray-200 mb-4 leading-relaxed">{{ post[1] }}</p>

                                {% if post[4] %}
                                    <div class="rounded-xl overflow-hidden mb-4 border border-gray-200 dark:border-gray-700">
                                        <img src="{{ url_for('static', filename='avatars/' + post[4]) }}"
                                             alt="Post image" class="w-full h-auto">
                                    </div>
                                {% endif %}

                                <div class="flex gap-6 mt-4 items-center">
                                    <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">
                                        {% if post[7] == 'like' %}Unlike{% else %}Like{% endif %}
                                    </button>
                                    <span class="like-count text-gray-500 dark:text-gray-400">{{ post[5] }} likes</span>
                                    <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">
                                        {% if post[7] == 'dislike' %}Undislike{% else %}Dislike{% endif %}
                                    </button>
                                    <span class="dislike-count text-gray-500 dark:text-gray-400">{{ post[6] }} dislikes</span>
                                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="{{ post[0] }}">Comment</button>
                                </div>

                                <!-- Latest Comment -->
                                {% if post[8] %}
                                    <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg" id="latest-comment-{{ post[0] }}">
                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>{{ post[8][2] }}</strong> <span class="text-gray-500 dark:text-gray-400">({{ post[8][1] }})</span></p>
                                        <p class="text-gray-700 dark:text-gray-300">{{ post[8][0] }}</p>
                                    </div>
                                {% else %}
                                    <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-{{ post[0] }}"></div>
                                {% endif %}

                                <div class="comments-section mt-4 hidden" id="comments-{{ post[0] }}">
                                    <div class="comments-list space-y-3"></div>
                                    <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="{{ post[0] }}">
                                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                                        <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if posts|length > 5 %}
                        <button id="loadMorePosts"
                                class="mt-6 w-full py-3 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:border-blue-500 hover:text-blue-600 dark:hover:border-blue-500 dark:hover:text-blue-400 transition flex items-center justify-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            Load More Posts
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Right Sidebar - Messages & Notifications & Search -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Chats -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg post-card">
                    <div class="flex items-center justify-between mb-5">
                        <h3 class="text-xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-white">
                                <i class="fas fa-comments"></i>
                            </div>
                            Messages
                        </h3>
                    </div>

                    <div id="chats-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        {% for chat in chats %}
                            <a href="{{ url_for('chat', chat_id=chat[0]) }}"
                               class="flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition group"
                               data-chat-id="{{ chat[0] }}">
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-teal-400 to-emerald-400 flex items-center justify-center text-white font-semibold">
                                        {{ chat[1][0]|upper }}
                                    </div>
                                    {% if chat[2] > 0 %}
                                        <span class="absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs rounded-full flex items-center justify-center font-bold">
                                            {{ chat[2] }}
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 dark:text-gray-200 group-hover:text-cyan-600 dark:group-hover:text-cyan-400 transition">
                                        {{ chat[1] }}
                                    </h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 truncate">Click to open chat</p>
                                </div>
                                <i class="fas fa-chevron-right text-gray-400 group-hover:text-cyan-500 transition"></i>
                            </a>
                        {% endfor %}
                        {% if not chats %}
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 mx-auto mb-3 flex items-center justify-center">
                                    <i class="fas fa-comment-slash text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 dark:text-gray-400">No messages yet</p>
                                <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Start a conversation!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Notifications -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg post-card">
                    <form id="notifications-form" style="display: none;">
                        {{ search_form.hidden_tag() }}
                    </form>
                    <div class="flex items-center justify-between mb-5">
                        <h3 class="text-xl font-bold flex items-center gap-3 text-gray-800 dark:text-gray-100">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 flex items-center justify-center text-white">
                                    <i class="fas fa-bell"></i>
                                </div>
                                {% if notifications %}
                                    <span class="notification-dot absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full border-2 border-white dark:border-gray-800 flex items-center justify-center text-xs text-white">
                                        {{ notifications|length }}
                                    </span>
                                {% endif %}
                            </div>
                            Notifications
                        </h3>
                        <button id="clear-notifications"
                                class="px-3 py-1.5 text-sm bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-lg hover:shadow transition flex items-center gap-1">
                            <i class="fas fa-trash-alt text-xs"></i>
                            Clear All
                        </button>
                    </div>

                    <div id="notifications-list" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        {% if notifications %}
                            {% for notification in notifications %}
                                <li class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                                    {{ notification[0] }}
                                    {% if notification[1] %}
                                        <span class="text-gray-500 dark:text-gray-400">({{ notification[1] }})</span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>
                        {% endif %}
                    </div>
                </div>

                <!-- Find Friends -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-lg post-card">
                    <h3 class="text-xl font-bold flex items-center gap-3 mb-4 text-gray-800 dark:text-gray-100">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white">
                            <i class="fas fa-search"></i>
                        </div>
                        Find Friends
                    </h3>
                    <form method="POST" action="{{ url_for('search_user') }}" class="space-y-3">
                        {{ search_form.hidden_tag() }}
                        <div class="relative">
                            <input type="text" name="username" placeholder="Search for users..." required
                                   class="input-modern w-full pl-10 pr-4 py-3">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button type="submit"
                                class="btn-primary w-full py-3 rounded-xl font-semibold">
                            <i class="fas fa-search mr-2"></i>
                            Search
                        </button>
                    </form>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
                        N
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">NaNa Social Network</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">© 2025 • Connect with the world</p>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <a href="{{ url_for('logout') }}"
                       class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition font-medium">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <i class="fas fa-crown text-yellow-500 mr-1"></i>
                        CEO: Kasatkin K.
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Story Modal -->
    <div id="storyModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
                    <i class="fas fa-camera text-blue-500"></i>
                    Story View
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <div id="storyMedia" class="w-full h-96 mb-4 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                    <!-- Media will be inserted here -->
                </div>
                <p id="storyCaption" class="text-gray-800 dark:text-gray-200 text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl"></p>
            </div>
            <button onclick="closeModal()" class="w-full py-3 rounded-xl bg-gradient-to-r from-gray-800 to-gray-900 dark:from-gray-700 dark:to-gray-800 text-white font-semibold hover:shadow transition">
                Close Story
            </button>
        </div>
    </div>

    <!-- Post Modal -->
    <div id="postModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-2xl mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-3">
                    <i class="fas fa-robot text-purple-500"></i>
                    Choose Your Post
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="p-5 rounded-xl border-2 border-blue-200 dark:border-blue-800 bg-blue-50/50 dark:bg-blue-900/20">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center gap-2">
                        <i class="fas fa-user text-blue-500"></i>
                        Original Post
                    </h3>
                    <p id="originalPost" class="p-4 bg-white dark:bg-gray-700 rounded-xl text-gray-800 dark:text-gray-200 mb-4"></p>
                    <button onclick="submitPost('original')"
                            class="w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-semibold hover:shadow transition">
                        Post Original
                    </button>
                </div>

                <div class="p-5 rounded-xl border-2 border-purple-200 dark:border-purple-800 bg-purple-50/50 dark:bg-purple-900/20">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center gap-2">
                        <i class="fas fa-magic text-purple-500"></i>
                        AI Enhanced
                    </h3>
                    <p id="enhancedPost" class="p-4 bg-white dark:bg-gray-700 rounded-xl text-gray-800 dark:text-gray-200 mb-4"></p>
                    <button onclick="submitPost('enhanced')"
                            class="w-full py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold hover:shadow transition">
                        Post Enhanced
                    </button>
                </div>
            </div>

            <button onclick="closeModal()"
                    class="mt-6 w-full py-3 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:border-gray-400 dark:hover:border-gray-500 transition">
                Cancel
            </button>
        </div>
    </div>

    <script>
        const socket = io.connect(window.location.origin);
        const userId = {{ session['user_id'] | tojson }};

        socket.on('connect', () => {
            console.log('Connected to SocketIO server');
            socket.emit('join_room', userId);
            console.log(`Joined user room: ${userId}`);
        });

        socket.on('connect_error', (error) => {
            console.error('SocketIO connection error:', error);
        });

        socket.on('update_notifications', function(data) {
            if (data.user_id !== userId) return;
            console.log('Received update_notifications:', data);
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            if (data.notifications && data.notifications.length > 0) {
                data.notifications.forEach(notification => {
                    const li = document.createElement('li');
                    li.className = 'p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                    const content = notification[0];
                    const created_at = notification[1] ? ` <span class="text-gray-500 dark:text-gray-400">(${notification[1]})</span>` : '';
                    li.innerHTML = content + created_at;
                    notificationsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'p-3 text-gray-500 dark:text-gray-400 italic';
                li.textContent = 'No new notifications';
                notificationsList.appendChild(li);
            }
        });

        socket.on('new_message', function(data) {
            if (data.sender_id !== userId) {
                console.log('New message received:', data);
                const chatsList = document.getElementById('chats-list');
                const chatItem = chatsList.querySelector(`[data-chat-id="${data.chat_id}"]`);
                if (chatItem) {
                    const unreadSpan = chatItem.querySelector('span');
                    let unreadCount = unreadSpan ? parseInt(unreadSpan.textContent) + 1 : 1;
                    if (unreadSpan) {
                        unreadSpan.textContent = unreadCount;
                    } else {
                        const newSpan = document.createElement('span');
                        newSpan.className = 'absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs rounded-full flex items-center justify-center font-bold';
                        newSpan.textContent = unreadCount;
                        chatItem.querySelector('.relative').appendChild(newSpan);
                    }
                }
            }
        });

        document.getElementById('clear-notifications').addEventListener('click', () => {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch('/clear_notifications', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Notifications cleared');
                    const notificationsList = document.getElementById('notifications-list');
                    notificationsList.innerHTML = '<li class="p-3 text-gray-500 dark:text-gray-400 italic">No new notifications</li>';
                } else {
                    console.error('Failed to clear notifications:', data.message);
                    alert('Failed to clear notifications: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error clearing notifications:', error);
                alert('Error clearing notifications. Please try again.');
            });
        });

        socket.on('new_friend_request', function(data) {
            if (data.sender_id !== userId) {
                const friendRequests = document.querySelector('.friend-requests');
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700';
                li.dataset.senderId = data.sender_id;
                li.innerHTML = `
                    <span class="font-medium text-gray-700 dark:text-gray-300">${data.sender_username}</span>
                    <div class="flex gap-2">
                        <form action="/accept_friend/${data.sender_id}" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="${document.querySelector('#notifications-form input[name="csrf_token"]').value}">
                            <button type="submit" class="px-4 py-2 bg-blue-500 dark:bg-blue-600 text-white rounded-lg hover:bg-blue-600 dark:hover:bg-blue-700 hover:scale-105 transition min-h-12">Accept</button>
                        </form>
                        <form action="/reject_friend/${data.sender_id}" method="POST" class="inline">
                            <input type="hidden" name="csrf_token" value="${document.querySelector('#notifications-form input[name="csrf_token"]').value}">
                            <button type="submit" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 hover:scale-105 transition min-h-12">Reject</button>
                        </form>
                    </div>
                `;
                friendRequests.appendChild(li);
            }
        });

        socket.on('friend_request_accepted', function(data) {
            if (data.friend_id !== userId) {
                const friendList = document.querySelector('.friend-list');
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition';
                li.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-500 dark:text-blue-400"></i>
                    </div>
                    <a href="/create_chat/${data.friend_id}" class="text-blue-500 dark:text-blue-400 hover:underline font-medium">${data.friend_username}</a>
                `;
                friendList.appendChild(li);
                const requestLi = document.querySelector(`.friend-requests li[data-sender-id="${data.friend_id}"]`);
                if (requestLi) requestLi.remove();
            }
        });

        socket.on('friend_request_rejected', function(data) {
            if (data.friend_id !== userId) {
                const requestLi = document.querySelector(`.friend-requests li[data-sender-id="${data.friend_id}"]`);
                if (requestLi) requestLi.remove();
            }
        });

        socket.on('new_post', function(data) {
            const postsContainer = document.getElementById('posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 post-card';
            postDiv.dataset.postId = data.id;
            const emotion = data.emotion ? ` <span class="text-blue-500 dark:text-blue-400"> | Эмоция: ${data.emotion}</span>` : '';
            postDiv.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-semibold text-lg">
                            ${data.username[0].toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">${data.username}</h4>
                            <div class="flex items-center gap-2 text-sm">
                                <span class="text-gray-500 dark:text-gray-400">${data.created_at}</span>
                                ${emotion}
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-gray-800 dark:text-gray-200 mb-4 leading-relaxed">${data.content}</p>

                ${data.image ? `<div class="rounded-xl overflow-hidden mb-4 border border-gray-200 dark:border-gray-700">
                    <img src="${data.image}" alt="Post image" class="w-full h-auto">
                </div>` : ''}

                <div class="flex gap-6 mt-4 items-center">
                    <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Like</button>
                    <span class="like-count text-gray-500 dark:text-gray-400">${data.likes} likes</span>
                    <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Dislike</button>
                    <span class="dislike-count text-gray-500 dark:text-gray-400">${data.dislikes} dislikes</span>
                    <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${data.id}">Comment</button>
                </div>

                <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-${data.id}"></div>

                <div class="comments-section mt-4 hidden" id="comments-${data.id}">
                    <div class="comments-list space-y-3"></div>
                    <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="${data.id}">
                        <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                        <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                    </form>
                </div>
            `;
            postsContainer.prepend(postDiv);
            attachCommentListeners();
            attachReactionListeners();
        });

        socket.on('post_reaction_updated', function(data) {
            const post = document.querySelector(`.post-card[data-post-id="${data.post_id}"]`);
            if (post) {
                const likeButton = post.querySelector('.like-btn');
                const dislikeButton = post.querySelector('.dislike-btn');
                const likeSpan = post.querySelector('.like-count');
                const dislikeSpan = post.querySelector('.dislike-count');
                likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                likeSpan.textContent = `${data.likes} likes`;
                dislikeSpan.textContent = `${data.dislikes} dislikes`;
            }
        });

        socket.on('new_story', function(data) {
            if (data.user_id !== userId) {
                const storiesContainer = document.querySelector('.stories-container');
                const storyDiv = document.createElement('div');
                storyDiv.className = 'flex flex-col items-center flex-shrink-0';

                const ext = data.image ? data.image.split('.').pop().toLowerCase() : '';
                const mediaHTML = data.image ?
                    (['mp4', 'mov', 'avi'].includes(ext) ?
                        `<video src="{{ url_for('serve_story_file', filename='') }}${data.image}" class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-800"></video>` :
                        `<img src="{{ url_for('serve_story_file', filename='') }}${data.image}" alt="Story" class="w-20 h-20 rounded-full object-cover border-4 border-white dark:border-gray-800">`) :
                    `<div class="w-20 h-20 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600 border-4 border-white dark:border-gray-800 flex items-center justify-center">
                        <i class="fas fa-feather text-gray-400 dark:text-gray-500 text-xl"></i>
                    </div>`;

                storyDiv.innerHTML = `
                    <div class="story-circle mb-3">
                        <div class="story-inner">
                            ${mediaHTML}
                        </div>
                    </div>
                    <p class="text-sm text-center font-medium text-gray-700 dark:text-gray-300 truncate max-w-[100px] mb-2">
                        ${data.content || 'Story'}
                    </p>
                    <button onclick="viewStory(${data.story_id})" class="story-view-btn">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                `;
                storiesContainer.appendChild(storyDiv);
            }
        });

        function attachReactionListeners() {
            document.querySelectorAll('.like-btn').forEach(button => {
                button.removeEventListener('click', handleLikeClick);
                button.addEventListener('click', handleLikeClick);
            });

            document.querySelectorAll('.dislike-btn').forEach(button => {
                button.removeEventListener('click', handleDislikeClick);
                button.addEventListener('click', handleDislikeClick);
            });
        }

        function handleLikeClick() {
            const postId = this.dataset.postId;
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/like_post/${postId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const post = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                    const likeButton = post.querySelector('.like-btn');
                    const dislikeButton = post.querySelector('.dislike-btn');
                    const likeSpan = post.querySelector('.like-count');
                    const dislikeSpan = post.querySelector('.dislike-count');
                    likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                    dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                    likeSpan.textContent = `${data.likes} likes`;
                    dislikeSpan.textContent = `${data.dislikes} dislikes`;
                } else {
                    alert('Error liking post: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error liking post:', error);
                alert('Error liking post. Please try again.');
            });
        }

        function handleDislikeClick() {
            const postId = this.dataset.postId;
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/dislike_post/${postId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const post = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                    const likeButton = post.querySelector('.like-btn');
                    const dislikeButton = post.querySelector('.dislike-btn');
                    const likeSpan = post.querySelector('.like-count');
                    const dislikeSpan = post.querySelector('.dislike-count');
                    likeButton.textContent = data.user_reaction === 'like' ? 'Unlike' : 'Like';
                    dislikeButton.textContent = data.user_reaction === 'dislike' ? 'Undislike' : 'Dislike';
                    likeSpan.textContent = `${data.likes} likes`;
                    dislikeSpan.textContent = `${data.dislikes} dislikes`;
                } else {
                    alert('Error disliking post: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error disliking post:', error);
                alert('Error disliking post. Please try again.');
            });
        }

        function submitPost(type) {
            const postContent = document.getElementById('postContent');
            if (type === 'original') {
                postContent.value = document.getElementById('originalPost').textContent;
            } else {
                postContent.value = document.getElementById('enhancedPost').textContent;
            }
            document.getElementById('postForm').submit();
        }

        function closeModal() {
            document.getElementById('postModal').classList.add('hidden');
            document.getElementById('storyModal').classList.add('hidden');
        }

        document.getElementById('aiEnhanceBtn').addEventListener('click', () => {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                alert('Please enter some text to enhance.');
                return;
            }
            fetch('/enhance_post', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('#notifications-form input[name="csrf_token"]').value
                },
                body: JSON.stringify({ content })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const originalPost = document.getElementById('originalPost');
                    const enhancedPost = document.getElementById('enhancedPost');
                    originalPost.textContent = data.original_content || 'No original content';
                    enhancedPost.textContent = data.enhanced_content || data.original_content + '.';
                    document.getElementById('postModal').classList.remove('hidden');
                } else {
                    alert('Error enhancing post: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error enhancing post:', error);
                alert('Error enhancing post. Please try again or check the console for details.');
            });
        });

        let currentOffset = 5;

        document.getElementById('loadMorePosts')?.addEventListener('click', () => {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/get_more_posts?offset=${currentOffset}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.posts.length > 0) {
                    const postsContainer = document.getElementById('posts');
                    data.posts.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 post-card';
                        postDiv.dataset.postId = post.id;
                        const emotion = post.emotion ? ` <span class="text-blue-500 dark:text-blue-400"> | Эмоция: ${post.emotion}</span>` : '';
                        postDiv.innerHTML = `
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400 flex items-center justify-center text-white font-semibold text-lg">
                                        ${post.username[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800 dark:text-gray-200">${post.username}</h4>
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="text-gray-500 dark:text-gray-400">${post.created_at}</span>
                                            ${emotion}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p class="text-gray-800 dark:text-gray-200 mb-4 leading-relaxed">${post.content}</p>

                            ${post.image ? `<div class="rounded-xl overflow-hidden mb-4 border border-gray-200 dark:border-gray-700">
                                <img src="${post.image}" alt="Post image" class="w-full h-auto">
                            </div>` : ''}

                            <div class="flex gap-6 mt-4 items-center">
                                <button class="like-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Like</button>
                                <span class="like-count text-gray-500 dark:text-gray-400">${post.likes} likes</span>
                                <button class="dislike-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Dislike</button>
                                <span class="dislike-count text-gray-500 dark:text-gray-400">${post.dislikes} dislikes</span>
                                <button class="comment-btn text-blue-500 dark:text-blue-400 font-semibold hover:text-blue-600 dark:hover:text-blue-300 transition duration-300" data-post-id="${post.id}">Comment</button>
                            </div>

                            <div class="latest-comment mt-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg hidden" id="latest-comment-${post.id}"></div>

                            <div class="comments-section mt-4 hidden" id="comments-${post.id}">
                                <div class="comments-list space-y-3"></div>
                                <form class="comment-form mt-4 flex flex-col gap-4" data-post-id="${post.id}">
                                    <textarea name="comment_content" placeholder="Write a comment..." required class="w-full p-3 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-700 text-gray-700 dark:text-gray-300 dark:bg-gray-700 min-h-24"></textarea>
                                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transform hover:scale-105 transition duration-300">Send</button>
                                </form>
                            </div>
                        `;
                        postsContainer.appendChild(postDiv);
                    });
                    currentOffset += 5;
                    if (data.posts.length < 5) {
                        document.getElementById('loadMorePosts').remove();
                    }
                    attachCommentListeners();
                    attachReactionListeners();
                } else {
                    document.getElementById('loadMorePosts').remove();
                }
            })
            .catch(error => {
                console.error('Error loading more posts:', error);
                alert('Error loading more posts. Please try again.');
            });
        });

        function fetchComments(postId) {
            fetch(`/get_comments/${postId}`)
                .then(response => response.json())
                .then(data => {
                    const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
                    commentsList.innerHTML = '';
                    if (data.status === 'success' && data.comments.length > 0) {
                        data.comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${comment.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${comment.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${comment.content}</p>
                            `;
                            commentsList.appendChild(commentDiv);
                        });
                    } else {
                        commentsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No comments yet.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                });
        }

        function attachCommentListeners() {
            document.querySelectorAll('.comment-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const postId = button.dataset.postId;
                    const commentsSection = document.getElementById(`comments-${postId}`);
                    commentsSection.classList.toggle('hidden');
                    if (!commentsSection.classList.contains('hidden')) {
                        fetchComments(postId);
                    }
                });
            });

            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const postId = form.dataset.postId;
                    const content = form.querySelector('textarea').value;
                    fetch('/add_comment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('#notifications-form input[name="csrf_token"]').value
                        },
                        body: JSON.stringify({ post_id: postId, content })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'p-3 bg-gray-100 dark:bg-gray-700 rounded-lg';
                            commentDiv.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>
                            `;
                            commentsList.appendChild(commentDiv);
                            const latestComment = document.getElementById(`latest-comment-${postId}`);
                            latestComment.innerHTML = `
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-200"><strong>${data.username}</strong> <span class="text-gray-500 dark:text-gray-400">(${data.created_at})</span></p>
                                <p class="text-gray-700 dark:text-gray-300">${content}</p>
                            `;
                            latestComment.classList.remove('hidden');
                            form.querySelector('textarea').value = '';
                        } else {
                            alert('Error adding comment: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error adding comment:', error);
                        alert('Error adding comment. Please try again.');
                    });
                });
            });
        }

        function viewStory(storyId) {
            const csrfToken = document.querySelector('#notifications-form input[name="csrf_token"]').value;
            fetch(`/view_story/${storyId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetch(`/get_story/${storyId}`)
                        .then(response => response.json())
                        .then(story => {
                            if (story.status === 'success') {
                                const mediaDiv = document.getElementById('storyMedia');
                                const captionDiv = document.getElementById('storyCaption');
                                if (story.image) {
                                    const ext = story.image.split('.').pop().toLowerCase();
                                    if (['mp4', 'mov', 'avi'].includes(ext)) {
                                        mediaDiv.innerHTML = `<video controls class="max-w-full max-h-96 object-contain rounded-lg"><source src="{{ url_for('serve_story_file', filename='') }}${story.image}" type="video/${ext}">Your browser does not support the video tag.</video>`;
                                    } else {
                                        mediaDiv.innerHTML = `<img src="{{ url_for('serve_story_file', filename='') }}${story.image}" alt="Story" class="max-w-full max-h-96 object-contain rounded-lg">`;
                                    }
                                } else {
                                    mediaDiv.innerHTML = `<div class="w-full h-96 bg-gray-200 dark:bg-gray-700 flex items-center justify-center rounded-lg"><span class="text-gray-500 dark:text-gray-400">No Media</span></div>`;
                                }
                                captionDiv.textContent = story.content || 'No caption';
                                document.getElementById('storyModal').classList.remove('hidden');
                            } else {
                                alert('Error loading story: ' + story.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching story:', error);
                            alert('Error loading story. Please try again.');
                        });
                } else {
                    alert('Error viewing story: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error viewing story:', error);
                alert('Error viewing story. Please try again.');
            });
        }

        attachCommentListeners();
        attachReactionListeners();

        const urlParams = new URLSearchParams(window.location.search);
        const photoPath = urlParams.get('photo_path');
        const emotion = urlParams.get('emotion');
        const content = urlParams.get('content');
        if (photoPath) {
            document.getElementById('photoPath').value = photoPath;
            const filename = photoPath.split('/').pop();
            document.getElementById('photoPreview').innerHTML = `
                <div class="rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 mt-3">
                    <img src="{{ url_for('static', filename='avatars/') }}${filename}" alt="Captured photo" class="w-full h-48 object-cover">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-300">Captured Photo</span>
                        <button type="button" onclick="this.parentElement.parentElement.remove()"
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>`;
            if (emotion) {
                document.getElementById('emotionInput').value = emotion;
            }
            if (content) {
                document.getElementById('postContent').value = content;
            }
        }

        // Обработчик для загрузки изображения в пост
        document.getElementById('postImageInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = `
                        <div class="rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 mt-3">
                            <img src="${event.target.result}" alt="Preview" class="w-full h-48 object-cover">
                            <div class="p-3 bg-gray-50 dark:bg-gray-700 flex justify-between items-center">
                                <span class="text-sm text-gray-600 dark:text-gray-300">${file.name}</span>
                                <button type="button" onclick="this.parentElement.parentElement.remove()"
                                        class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>

